/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package io.warp10.warpfleet.synchronizer;

import io.warp10.warpfleet.synchronizer.api.RepositoriesManager;
import org.eclipse.jgit.api.errors.GitAPIException;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;

import static spark.Spark.before;
import static spark.Spark.delete;
import static spark.Spark.exception;
import static spark.Spark.get;
import static spark.Spark.ipAddress;
import static spark.Spark.notFound;
import static spark.Spark.options;
import static spark.Spark.port;
import static spark.Spark.post;
import static spark.Spark.put;
import static spark.Spark.staticFiles;
import static spark.Spark.threadPool;

/**
 * The type Warp fleet synchronizer.
 */
public class WarpFleetSynchronizer {
  private static Logger LOG = LoggerFactory.getLogger(WarpFleetSynchronizer.class);
  private static RepositoriesManager repositoriesManager;

  /**
   * The entry point of application.
   *
   * @param args the input arguments
   */
  @SuppressWarnings("DanglingJavadoc")
  public static void main(String[] args) {
    if (args.length != 1) {
      LOG.error("Missing configuration file");
      System.exit(1);
    }
    try {
      repositoriesManager = new RepositoriesManager(args[0], "macros/macros");

      port(repositoriesManager.getConf().optInt("port", 8082));
      ipAddress(repositoriesManager.getConf().optString("host", "0.0.0.0"));
      threadPool(8);
      // Serving macros
      staticFiles.externalLocation(new File(repositoriesManager.getMacroPath()).getParentFile().getAbsolutePath());

      // add CORS
      options("/api/*", (req, res) -> {
        String accessControlRequestHeaders = req.headers("Access-Control-Request-Headers");
        if (accessControlRequestHeaders != null) {
          res.header("Access-Control-Allow-Headers", accessControlRequestHeaders);
        }
        String accessControlRequestMethod = req.headers("Access-Control-Request-Method");
        if (accessControlRequestMethod != null) {
          res.header("Access-Control-Allow-Methods", accessControlRequestMethod);
        }
        return "OK";
      });

      // Before filter
      before("/macros/*", (req, res) -> res.header("Content-Type", "text/plain"));
      before("/api/*", (req, res) -> {
        res.header("Access-Control-Allow-Origin", repositoriesManager.getConf().optString("remotes", ""));
        res.header("Access-Control-Request-Method", "GET,PUT,OPTIONS,DELETE");
        res.header("Access-Control-Allow-Headers", "*");
        res.header("Content-Type", "application/json");
      });

      /**
       * @api {get} /api/repos Request all configured repos
       * @apiName getRepos
       * @apiParam {String} owner Repository owner id.
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiSuccess {Object[]}  repos list of git repositories.
       */
      get("/api/repos/:owner", (req, res) -> repositoriesManager.getRepos(req.params(":owner")));

      /**
       * @api {get} /api/reload Reload configuration file
       * @apiName reloadConf
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiSuccess {Object}  status status.
       */
      get("/api/reload", (req, res) -> repositoriesManager.reloadConf());

      /**
       * @api {get} /api/repos/:repo fetch a repository by its name
       * @apiName getRepo
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiParam {String} repo Repository name.
       * @apiParam {String} owner Repository owner id.
       *
       * @apiSuccess {Object}  repository Repository.
       */
      get("/api/repos/:owner/:repo", (req, res) -> repositoriesManager.getRepo(req.params(":owner"), req.params(":repo")));

      /**
       * @api {delete} /api/repos/:repo delete a repository by its name
       * @apiName deleteRepository
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiParam {String} repo Repository name.
       * @apiParam {String} owner Repository owner id.
       *
       * @apiSuccess {Object}  status status.
       */
      delete("/api/repos/:owner/:repo", (req, res) -> new JSONObject().put("status", repositoriesManager.deleteRepository(req.params(":owner"), req.params(":repo"))));

      /**
       * @api {put} /api/repos Add a new repository
       * @apiName addRepository
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiParam {Object} repository Repository.
       * @apiParam {String} owner Repository owner id.
       *
       * @apiSuccess {Object}  status status.
       */
      put("/api/repos/:owner", (req, res) -> new JSONObject().put("status", repositoriesManager.addRepository(req.params(":owner"), new JSONObject(req.body()))));
      /**
       * @api {put} /api/repos update a repository by its name
       * @apiName updateRepository
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiParam {Object} repository Repository.
       * @apiParam {String} owner Repository owner id.
       * @apiParam {String} repo Repository name.
       *
       * @apiSuccess {Object}  status status.
       */
      put("/api/repos/:owner/:repo", (req, res) -> new JSONObject().put("status", repositoriesManager.updateRepository(req.params(":owner"), req.params(":repo"), new JSONObject(req.body()))));

      /**
       * @api {get} /api/sync/:repo synchronize a particular repo
       * @apiName sync
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiParam {String} repo Repository name.
       *
       * @apiSuccess {Object}  status status.
       */
      get("/api/sync/:repo", (req, res) -> new JSONObject().put("status", repositoriesManager.sync(req.params(":repo"))));

      /**
       * @api {post} /api/sync/:repo synchronize a particular repo
       * @apiName sync
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiParam {String} repo Repository name.
       *
       * @apiSuccess {Object}  status status.
       */
      post("/api/sync/:repo", (req, res) -> new JSONObject().put("status", repositoriesManager.sync(req.params(":repo"))));

      /**
       * @api {get} /api/sync synchronize all
       * @apiName syncAll
       * @apiGroup WarpFleetSynchronizer
       *
       * @apiSuccess {Object}  status status.
       */
      get("/api/sync", (req, res) -> new JSONObject().put("status", repositoriesManager.syncAll()));


      // exception catching
      exception(Exception.class, (e, req, res) -> {
        LOG.error(e.getMessage(), e);
        res.status(500);
        res.body(new JSONObject().put("message", e.getMessage()).toString());
      });

      exception(GitAPIException.class, (e, req, res) -> {
        LOG.error(e.getMessage(), e);
        res.status(501);
        res.body(new JSONObject().put("message", e.getMessage()).toString());
      });

      // 404 catching
      notFound((req, res) -> {
        res.status(404);
        return new JSONObject().put("message", "Not found");
      });

    } catch (Exception e) {
      LOG.error(e.getMessage(), e);
      System.exit(1);
    }
  }
}
